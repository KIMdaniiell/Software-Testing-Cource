# Модульное тестирование (a.k.a. Юнит тестирование)
\- тестирование отдельных компонентов ПО:
+ **Классов**
+ **Методов**
+ **Программных модулей**, описанных в дизайне


# Изолирование модулей
+ **Драйвер** - система замещающая вызывающий модуль (Например JUnit)
    + Подготавливает окружение и входные данные
    + Дополнительно
      + Запускает серию тестов
      + Настраивает заглушки
      + Формирует журнал результатов 
+ **Заглушка (stub)** - используется вместо вызывающего модуля и эмулирует его поведение и интерфейс 
  

# Анализ результатов теста
Необходимо знать:
+ Входные и выходные данные
+ Значения измененных переменных (состояние)
+ Пройденные пути/принятые решения (алгоритм)
+ Симптомы сбоя

---

# Фреймворк - JUnit 4
[статья 1 (JUnit 4)](https://www.vogella.com/tutorials/JUnit4/article.html),    [статья 2 (JUnit 3 & JUnit 4)](https://habr.com/ru/articles/120101/)
+ Для обозначения методов в качестве тестов использует **аннотации**
+ Для классов, содержащий методы-тесты, принято называть - *ЦельТестирования***Test**
+ Название метода-теста должно отображать, что происходит в тесте (можно использовать *should* или *Given[ExplainYourInput]When[WhatIsDone]Then[ExpectedResult]*)

### Аннотации 
Методы-тесты, которые маркируются аннотациями должны иметь следующие модификаторы: **public [*static*] void**

```
=================================================================================================================================
|  @Test                                |  Маркирует метод как тест                                                             │
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  @Before                              |  Исполняется ПЕРЕД КАЖДЫМ тестом,                                                     |
|                                       |  подготавливает окружение теста (инициализация переменных, объектов, чтение данных)   |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  @After                               |  Исполняется ПОСЛЕ КАЖДЫМ тестом,                                                     |
|                                       |  очищая окружение теста, высвобождает память                                          |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  static @BeforeClass                  |  Исполняется ОДИН РАЗ в САМОМ НАЧАЛЕ тестирования,                                    |
|                                       |  выполняет времязатратные действия                                                    |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  static @AfterClass                   |  Исполняется ОДИН РАЗ в САМОМ КОНЦЕ ПОСЛЕ тестирования,                               |
|                                       |  производит очищение                                                                  |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  @Ignore или @Ignore("Why disabled")  |  Отключает тест, например, если тестируемый функционал был отредактирован,            |
|                                       |  а тест еще не адаптирован под изменения                                              |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  @Test (expected = Exception.class)   |  Завершается ошибкой, если метод НЕ генерирует заданное исключение                    |
├───────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────┤
|  @Test(timeout=100)                   |  Завершается неудачей, если выполнение метода занимает более 100 миллисекунд          |
=================================================================================================================================
```

### Методы сравнения (assertions)
[статья (JUnit 4 и JUnit 5)](https://www.baeldung.com/junit-assertions)

*В методах в качестве первого параметра (в JUnit 5 **message** - последний параметр ) дополнительно можно(нужно) указать **СООБЩЕНИЕ**, которое будет выводится при неудачном завершении теста.*

**!!!** Для сравнения ***float*** или ***double*** необходимо указывать ***delta*** - максимальная разница между значениями, при которой оба числа по-прежнему считаются равными.
```
================================================================================================================================
|  fail ()                                        | Заваливает тест.                                                           |
|                                                 | Для проверки, что определенное место в коде теста не достижимо             |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertTrue (boolean condition)                 |  Проверяет, что условие ИСТИННО                                            |
|  assertFalse (boolean condition)                |  Проверяет, что условие ЛОЖНО                                              |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertEquals (T expected, T actual)            |  Проверяет равенство значений                                              |
|  assertNotEquals (T expected, T actual)         |  Проверяет неравенство значений                                            |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertNull (Object object)                     |  Проверяет, что объект равен null                                          |
|  assertNotNull (Object object)                  |  Проверяет, что объект НЕ равен null                                       |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertSame (Object expected, Object actual)    |  Проверяет, что два объекта ссылаются на один и тот же объект              |
|  assertNotSame (Object expected, Object actual) |  Проверяет, что два объекта ссылаются на один и тот же объект              |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertArrayEquals (T[] expecteds, T[] actuals) |  Проверяет, что два массива объектов или примитивов равны по содержанию    |
├─────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────┤
|  assertThrows (Class<T> expectedThrowable, ThrowingRunnable runnable)                                                        |
|  Проверяет, что runnable выдает исключение типа expectedThrowable при выполнении                                             |  
================================================================================================================================
```

### Не расмотрено
+ Suite
+ Rules
+ RunWith (Запускалки - Drivers)

---


# Фреймворк - Mockito
[статья 1](https://habr.com/ru/articles/444982/), [статья 2](https://www.vogella.com/tutorials/Mockito/article.html)

1. Создание **mock** класса *DataService*:
    ```
        DataService dataServiceMock = Mockito.mock(DataService.class);
    ```
   Для созданного объекта
    + instanceof DataService вернёт true
    + dataServiceMock.getClass() — DataService.class
    + Для такого **mock** сразу после создания характерно некое поведение по умолчанию - все методы обычно возвращают:
        + **null** - для ссылочных(объетных) типов
        + **0** - для примитивных типов
        + **Пустую коллекцию** - если возвращаемый тип - коллекция 


2. Управление поведением
    ```
        List<String> data = new ArrayList<>();
        data.add("dataItem");
        Mockito.when(dataService.getAllData()).thenReturn(data);
    ```
    После этой операции, вызвав у объекта *dataService* метод *getAllData()*, получу объект, заданный в первой строчке листинга - *data*. Для одного и того же метода можно задать поведение несколько раз с разными требованиями к аргументам, и все определённые таким образом модели поведения будут действовать одновременно. При пересечении приоритет у того определения, что было задано позже.

    + Если нужно задать реакцию на любой вызов этого метода независимо от аргументов, нужно воспользоваться методом ***Mockito.any()***:
        ```
            Mockito.when(dataService.getDataItemById(any())).thenReturn("dataItem");   
        ```

    + Если требуется, чтобы ***mock*** реагировал только на определённое значение аргумента, можно использовать непосредственно это значение или методы ***Mockito.eq()*** (когда речь об эквивалентности) либо ***Mockito.same()*** (когда требуется сравнение ссылок):
        ```
            Mockito.when(dataService.getDataItemById("idValue")).thenReturn("dataItem");
            // or
            Mockito.when(dataService.getDataItemById(Mockito.eq("idValue"))).thenReturn("dataItem");
        ```

   + А если нужно, чтобы аргумент отвечал каким-то требованиям, для этого есть ряд удобных специализированных статических методов того же класса ***Mockito*** (например, строки можно проверить на содержание в начале или в конце определённой последовательности символов, соответствие паттерну и др.). Также имеется общий метод ***Mockito.argThat()*** (и его аналоги для примитивных типов), принимающий реализацию функционального интерфейса ***ArgumentMatcher***:
        ```
            Mockito.when(dataService.getDataById(
                Mockito.argThat(arg -> arg == null || arg.length() > 5)))
           .thenReturn("dataItem");
        ```
3. Задание результатов вызова
    + **.thenReturn(object);** - в случе, если нужно вернуть примитивный тип, будет происходить *un/boxing*
    + **.thenThrow(new IllegalArgumentException());**
    + **.thenThrow(IllegalArgumentException.class);**
    + **.thenAnswer** (пока не рассматривал)
...
